# OPNsense Configuration Scripts

A collection of Python scripts for managing OPNsense firewall configurations. These scripts help automate common migration and configuration tasks by directly manipulating OPNsense XML configuration files.

> **Note:** These scripts were generated by AI (Claude Opus 4.5).

## Scripts

| Script | Purpose |
|--------|---------|
| `convert_isc_dhcp_to_dnsmasq.py` | Migrate ISC DHCP to Dnsmasq (OPNsense 26.1+) |
| `add_vlan.py` | Add a new VLAN and interface assignment |
| `migrate_interfaces.py` | Rename interface devices for new hardware |

## Requirements

- Python 3.10+
- No external dependencies (uses only standard library)

## Usage

### 1. Convert ISC DHCP to Dnsmasq

Migrates ISC DHCP configuration to Dnsmasq DHCP format, which is the default DHCP server in OPNsense 26.1+.

```bash
python3 convert_isc_dhcp_to_dnsmasq.py <input_config.xml> [output_config.xml]
```

**Features:**
- Converts DHCP ranges per interface
- Converts static IP reservations (MAC-to-IP mappings)
- Converts DHCP options: DNS servers, NTP servers, domain names, WINS servers
- Optionally removes legacy ISC DHCP configuration
- Optionally removes `os-isc-dhcp` plugin reference

**Interactive Options:**
- Include disabled DHCP interfaces
- Replace or merge with existing Dnsmasq config
- Keep or remove ISC DHCP configuration
- Keep or remove ISC DHCP plugin from plugins list

**Example:**
```bash
python3 convert_isc_dhcp_to_dnsmasq.py config-backup.xml config-migrated.xml
```

---

### 2. Add VLAN

Interactively creates a new VLAN and assigns it to an interface.

```bash
python3 add_vlan.py <input_config.xml> [output_config.xml]
```

**Features:**
- Creates VLAN entry in `<vlans>` section
- Creates interface assignment as next available `optX`
- Validates VLAN ID uniqueness on parent interface
- Validates IP address format

**Prompts for:**
- Parent interface (e.g., `igb1`, `em0`)
- VLAN ID (1-4094)
- Description
- IP address and subnet mask

**Example:**
```bash
python3 add_vlan.py config.xml config-with-new-vlan.xml
```

**Sample Session:**
```
Available parent interfaces: igb0, igb1
Parent interface (e.g., igb1): igb1
VLAN ID (1-4094): 200
Description (e.g., HomeAssistant): IoT
IP address for interface: 192.168.200.1
Subnet (CIDR) [24]: 24

Configuration Summary
-----------------------------------
  Parent interface: igb1
  VLAN ID:          200
  VLAN interface:   igb1_vlan200
  Description:      IoT
  Assigned to:      opt5
  IP address:       192.168.200.1/24
```

---

### 3. Migrate Interfaces

Migrates interface device names when moving OPNsense to new hardware where NIC names have changed (e.g., `igb` to `igc` or `ix`).

```bash
python3 migrate_interfaces.py <input_config.xml> [output_config.xml]
```

**Features:**
- Auto-detects physical, virtual, and VLAN interfaces
- Shows where each interface is used (LAN, WAN, VLANs, etc.)
- Automatically renames VLAN interfaces when parent is renamed
- Updates all references: interfaces, VLANs, PPP/PPPoE

**Supported Interface Types:**
- Physical NICs: `igb`, `igc`, `ix`, `ixl`, `em`, `re`, `bge`, `vmx`, `vtnet`, etc.
- Virtual interfaces: `pppoe`, `wg`, `tun`, `tap`, `bridge`, `lagg`, etc.
- VLANs: Automatically renamed based on parent interface changes

**Example:**
```bash
python3 migrate_interfaces.py old-config.xml new-config.xml
```

**Sample Session:**
```
Discovered interfaces:
  Physical: igb0, igb1
  VLANs:    igb1_vlan100, igb1_vlan200

Physical Interface Migration
==================================================
igb0 (used by: WAN)
  New name [igb0]: igc0

igb1 (used by: LAN, parent of Guest, parent of IoT)
  New name [igb1]: igc1

VLAN Interface Auto-Rename
==================================================
  igb1_vlan100 -> igc1_vlan100
  igb1_vlan200 -> igc1_vlan200
```

---

## Workflow

1. **Export** your current OPNsense configuration:
   - Go to **System > Configuration > Backups**
   - Click **Download configuration**

2. **Run** the appropriate script on the exported XML file

3. **Review** the generated output file

4. **Import** the modified configuration:
   - Go to **System > Configuration > Backups**
   - Upload the modified config file
   - Reboot if necessary (especially for interface migrations)

## Important Notes

- **Always backup** your configuration before making changes
- **Review** the generated XML before importing
- Scripts write to **stdout** if no output file is specified
- All scripts are **interactive** and will prompt for confirmation before making changes

## License

These scripts are provided as-is for OPNsense configuration management. Use at your own risk.
